<html>
	<head>
		<title>Daimyo API documentation</title>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
		<style>body {
    margin: 0;
    padding: 0;
    font: 14px/1.5 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    color: #252519;
}
a {
    color: #252519;
}
a:hover {
    text-decoration: underline;
    color: #19469D;
}
p {
    margin: 12px 0;
}
h1, h2, h3 {
    margin: 0;
    padding: 0;
}
table#source {
    width: 100%;
    border-collapse: collapse;
}
table#source td:first-child {
    padding: 30px 40px 30px 40px;
    vertical-align: top;
}
table#source td:first-child,
table#source td:first-child pre {
    width: 450px;
}
table#source td:last-child {
    padding: 30px 0 30px 40px;
    border-left: 1px solid #E5E5EE;
    background: #F5F5FF;
}
table#source tr {
    border-bottom: 1px solid #E5E5EE;
}
table#source tr.filename {
    padding-top: 40px;
    border-top: 1px solid #E5E5EE;
}
table#source tr.filename td:first-child {
    text-transform: capitalize;
}
table#source tr.filename td:last-child {
    font-size: 12px;
}
table#source tr.filename h2 {
    margin: 0;
    padding: 0;
    cursor: pointer;
}
table#source tr.code h1,
table#source tr.code h2,
table#source tr.code h3 {
    margin-top: 30px;
    font-family: "Lucida Grande", "Helvetica Nueue", Arial, sans-serif;
    font-size: 18px;
}
table#source tr.code h2 {
    font-size: 16px;
}
table#source tr.code h3 {
    font-size: 14px;
}
table#source tr.code ul {
    margin: 15px 0 15px 35px;
    padding: 0;
}
table#source tr.code ul li {
    margin: 0;
    padding: 1px 0;
}
table#source tr.code ul li p {
    margin: 0;
    padding: 0;
}
table#source tr.code td:first-child pre {
    padding: 20px;
}
#ribbon {
    position: fixed;
    top: 0;
    right: 0;
}
code .string { color: #219161; }
code .regexp { color: #219161; }
code .keyword { color: #954121; }
code .number { color: #19469D; }
code .comment { color: #bbb; }
code .this { color: #19469D; }</style>
		<script>
			$(function(){
				$('tr.code').hide();
				$('tr.filename').toggle(function(){
					$(this).nextUntil('.filename').fadeIn();
				}, function(){
					$(this).nextUntil('.filename').fadeOut();
				});
			});
		</script>
	</head>
	<body>
<table id="source"><tbody><tr><td><h1>Daimyo API documentation</h1><h2>Getting started</h2>

<p>Fee Figters' <a href="http://feefighters.com/samurai">Samurai</a> payment gateway is
currently in beta. Before joining the beta program and getting an account, it
is highly recommended that you get your merchant account first. After signing
up with Samurai, you will receive three HEX tokens:</p>

<ul><li>Merchant key - used to identify your account on Samurai</li><li>API password - password for you Samurai account</li><li>Processor ID - the ID of the gateway that you will use for transactions</li></ul>

<p>Initially, you will receive a sandbox processor ID. The sandbox is used for
testing, and you cannot actually process transactions using the sandbox. Keep
in mind that you should only run unit tests that come with Daimyo using the
sandbox processor ID.</p>

<h3>Configuration</h3>

<p>Before you use any of the Daimyo's functions, you should configure Daimyo.</p>

<pre><code>var daimyo = require('daimyo');

daimyo.configure({
  merchantKey: 'xxxxxxxxxxxxxxxxxxxxxxxx',
  apiPassword: 'xxxxxxxxxxxxxxxxxxxxxxxx',
  processorId: 'xxxxxxxxxxxxxxxxxxxxxxxx'
});</code></pre>

<p>Samurai gatway uses transparent redirect method to process credit card 
information. The way it works is, user submits the card and billing data 
directly to Samurai, and it redirects the user back to your site attaching a 
payment method token to the request. You have to access to credit card data
in any part of the work flow. While this is a good method to use in most 
scnearios, it has one major drawback, and that is you cannot use this method 
if you site is an AJAX-only web app (so-called single-page app). Daimyo 
provides a <code>create</code> method, which allows you to create a payment method 
without using the transparent redirect. You should keep in mind that you have
to ensure that sensitive data passing through your site is properly secured.
Use SSL for every connection that passes sensitive data, and do not use GET
requests for such requests. Also make sure that no sensitive data is logged or 
stored in any part of your application.</p>

<p>One of the configuration options is <code>debug</code>, which enables logging of <em>all</em> 
data that passes through Daimyo. While it is disabled by default, you should
take utmost care to ensure it remains disabled in production. Double-check
you app's configuration.</p>

<h3>Card object</h3>

<p>If you chose to use the server-to-server method of creating payment methods,
you can create a new payment method using the <code>create</code> method. Suppse you have
received billing and creadit card data from your user. You can now create a new
Card object use that data.</p>

<pre><code>var card = new daimyo.Card({
  number: data.cardNumber,
  csc: data.csc,
  firstName: data.firstName,
  lastName: data.lastName,
  year: data.expirationYear,
  month: data.expirationMonth,
  ....
});</code></pre>

<p>The card object has following fields:</p>

<ul><li><em>number</em>: card number</li><li><em>csc</em>: card security code (called CCV, CVC, CVV, and various other names)</li><li><em>year</em>: expiration year (if any)</li><li><em>month</em>: expiration month</li><li><em>firstName</em>: card holder's first name</li><li><em>lastName</em>: card holder's last name</li><li><em>address1</em>: billing address line 1</li><li><em>address2</em>: billing address line 2</li><li><em>city</em>: billing address city</li><li><em>state</em>: billing address state/region</li><li><em>zip</em>: billing address zip/postal code</li></ul>

<p>You cannot create a card object unless you supply it a payment token, or credit 
card number and CSC. If you supply it a token, all other fields are ignored. 
Otherwise, card number and CSC are required, and you will get an error if you
do not specify them. If you create a card object with credit card and billing
details, you will get one more field:</p>

<ul><li><em>issuer</em>: name of the credit card's issuer</li></ul>

<p>The issuer is detected from the card number, and you should not set the field
manually (or allow the user to set it).</p>

<h3>Basic validation</h3>

<p>Once you've created the card object, you can test its validity:</p>

<pre><code>card.isValid(); // returns true if card is valid
card.isExpired(); // returns true if expired</code></pre>

<h3>Creating the payment method server-side</h3>

<p>The card, when initilized, is still not a valid <em>payment method</em>. You have to
actually create in on Samurai gateway in order to make purchases. You can do 
that like so:</p>

<pre><code>card.create(function(err) {
  // Handle errors
  // Card now has a payment method token associated with it
  console.log(card.token);
});</code></pre>

<h3>Loading the payment method</h3>

<p>Now that the card object has a token associated with it, you can either save
the token, or perform transactions with it. So, let's say you have stored the 
payment token, either when doing the transparent redirect, or after you created
the payment method using the <code>create</code> method. You can now use the <code>load</code> method
to fetch payment method details from Samurai server.</p>

<pre><code>var myToken = 'xxxxxxxxxxxxxxxxxxxxxxxx';
var card = new daimyo.Card({token: myToken});
card.load(function(err) {
  // Handle error
});</code></pre>

<p>The card object has all the fields populated. There are also two new fields:</p>

<ul><li>messages: contains any Samurai gateway messages about the card</li><li>method: contains meta-information about the payment method</li></ul>

<p>See the API documentation for details on what these fields contain.</p>

<h3>Updating the payment method</h3>

<p>If you want to update the card details, you can do so using the <code>update</code> 
method:</p>

<pre><code>card.firstName = 'Foo';
card.lastName = 'Bar';
card.address1 = '241 Bar St.';
card.city = 'Fooville';
card.update(function(err) {
  // Handle errors here
});</code></pre>

<h3>Retention and redaction</h3>

<p>Samurai has a built-in vault that can safely store your payment methods. Well,
they aren't yours, but... you know what I mean. :) Usage of this vault is
pretty much automatic. As soon as you create a new card, it is stored in the
vault.</p>

<p>By default, the stored payment methods will be deleted after 48 hours. If you
wish to keep the payment methods stored for longer periods, you can use the
<code>retain()</code> method. Let's say you have a newly created card. To retain it,
simply instruct the Samurai to do so:</p>

<pre><code>card.retain(function(err) {
  // Error handling here
  // The card now has a method property, 
  // which contains metadata about
  // the payment method. It has a `retained`
  // property which is now set to true:
  console.log(card.method.retained); // =&gt; true
});</code></pre>

<p>When your user supplies you a new card, or simply wants you to remove their 
records, use the <code>redact()</code> method to have the card removed from the Samurai
vault.</p>

<pre><code>card.redact(function(err) {
   // The card.method.retained is still true, but
   // card.method.redacted is now also true.
});</code></pre>

<p>Generally, you should not keep using a redacted payment method, so make sure
you check if the <code>card.method.redacted</code> is <code>true</code>. Updating the card data is
usually more efficient using the <code>update()</code> method. While it <em>is</em> more
effiicient, if you are using the transparent redirect method, you should 
redact the old card, and let the user enter a new one. Only use <code>update()</code> if 
you are using the server-to-server method.</p>

<p>REST OF THE DOCS IS ON TODO LIST, SORRY!</p></td><td></td></tr><tr class="filename"><td><h2 id="lib/config.js"><a href="#">config</a></h2></td><td>lib/config.js</td></tr><tr class="code">
<td class="docs">
<h1>config</h1>

<p>Copyright (c)2011, by Branko Vukelic</p>

<p>Configuration methods and settings for Daimyo. The three main objects a 
typical integration requires from this module are the <code>configure()</code> and 
<code>option()</code> methods, and the <code>settings</code> object.</p>

<ul><li><strong>author</strong>: <em>Branko</em>
Vukelic <a href="mailto:branko@herdhound.com">branko@herdhound.com</a></li><li><strong>license</strong>: <em>MIT</em>
(see LICENSE)</li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">config</span> = <span class="variable">exports</span>;
<span class="keyword">var</span> <span class="variable">util</span> = <span class="variable">require</span>(<span class="string">'util'</span>);
<span class="keyword">var</span> <span class="variable">samurayKeyRe</span> = <span class="regexp">/^[0-9a-f]{24}$/</span>;

<span class="variable">config</span>.<span class="class">DAIMYO_VERSION</span> = <span class="string">'0.0.1'</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>config.settings</h2>

<p><em>Master configuration settings for Daimyo</em></p>

<p>The <code>conifig.settings</code> contain all the code configuration options that 
affect the way certain things work (or not), and the Samurai gateway 
credentials. You should <em>not</em> access this object directly. The correct way
to access and set the settings is through either <code>configure()</code> or 
<code>option()</code> methods.</p>

<p>Settings are expected to contain following keys with their default values:</p>

<ul><li><em>merchantKey</em>: Samurai gateway Merchant Key (default: <code>''</code>)</li><li><em>apiPassword</em>: Samurai gateway API Password (default: <code>''</code>)</li><li><em>processorId</em>: Processor (gateway) ID; be sure to set this to a sandbox
ID for testing(default: <code>''</code>)</li><li><em>enabled</em>: Whether to actually make requests to gateway (default: true)</li><li><em>debug</em>: Whether to log to STDOUT; it is highly recommended that 
you disable this in production, to remain PCI comliant, and to 
avoid performance issues (default: true)</li></ul>

<p>The <code>apiVersion</code> setting is present for conveinence and is should be 
treated as a constant (i.e., read-only).
 </p>
</td>
<td class="code">
<pre><code><span class="variable">config</span>.<span class="variable">settings</span> = {};
<span class="variable">config</span>.<span class="variable">settings</span>.<span class="variable">merchantKey</span> = <span class="string">''</span>;
<span class="variable">config</span>.<span class="variable">settings</span>.<span class="variable">apiPassword</span> = <span class="string">''</span>;
<span class="variable">config</span>.<span class="variable">settings</span>.<span class="variable">processorId</span> = <span class="string">''</span>;
<span class="variable">config</span>.<span class="variable">settings</span>.<span class="variable">enabled</span> = <span class="variable">true</span>; <span class="comment">// Does not make any actual API calls if false</span>
<span class="variable">config</span>.<span class="variable">settings</span>.<span class="variable">debug</span> = <span class="variable">false</span>; <span class="comment">// Enables *blocking* debug output to STDOUT</span>
<span class="variable">config</span>.<span class="variable">settings</span>.<span class="variable">apiVersion</span> = <span class="number integer">1</span>; <span class="comment">// Don't change this... unless you need to</span></code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>config.configure(opts)</h2>

<p><em>Set global Daimyo configuration options</em></p>

<p>This method should be used before using any of the Daimyo's functions. It
sets the options in the <code>config.settings</code> object, and performs basic 
validation of the options before doing so.</p>

<p>This method depends on <code>config.option()</code> method to set the individual 
options.</p>

<p>If an invalid option is passed, it will throw an error.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  Configuration options</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">config</span>.<span class="variable">configure</span> = <span class="keyword">function</span>(<span class="variable">opts</span>) {
  <span class="variable">debug</span>(<span class="string">'Configuring Daimyo with: \n'</span> + <span class="variable">util</span>.<span class="variable">inspect</span>(<span class="variable">opts</span>));
  <span class="keyword">if</span> (!<span class="variable">opts</span>.<span class="variable">merchantKey</span> || !<span class="variable">opts</span>.<span class="variable">apiPassword</span> || !<span class="variable">opts</span>.<span class="variable">processorId</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Incomplete Samurai API credentials'</span>);
  }
  <span class="class">Object</span>.<span class="variable">keys</span>(<span class="variable">opts</span>).<span class="variable">forEach</span>(<span class="keyword">function</span>(<span class="variable">key</span>) {
    <span class="variable">config</span>.<span class="variable">option</span>(<span class="variable">key</span>, <span class="variable">opts</span>[<span class="variable">key</span>]);
  });
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>config.option(name, [value])</h2>

<p><em>Returns or sets a single configuration option</em></p>

<p>If value is not provided this method returns the value of the named
configuration option key. Otherwise, it sets the value and returns it.</p>

<p>Samurai API credentials are additionally checked for consistency. If they 
do not appear to be valid keys, an error will be thrown.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  option Name of the option key</p></li><li><p><strong>param</strong>: <em>Object</em>  value New value of the option</p></li><li><p><strong>returns</strong>: <em>Object</em>  Value of the <code>option</code> key</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">config</span>.<span class="variable">option</span> = <span class="keyword">function</span>(<span class="variable">option</span>, <span class="variable">value</span>) {
  <span class="keyword">if</span> (<span class="variable">value</span>) {
    <span class="variable">debug</span>(<span class="string">'Setting Daimyo key `'</span> + <span class="variable">option</span> + <span class="string">'` to `'</span> + <span class="variable">value</span>.<span class="variable">toString</span>() + <span class="string">'`'</span>);
  }
  <span class="keyword">switch</span> (<span class="variable">option</span>) {
  <span class="keyword">case</span> <span class="string">'merchantKey'</span>:
  <span class="keyword">case</span> <span class="string">'apiPassword'</span>:
  <span class="keyword">case</span> <span class="string">'processorId'</span>:
    <span class="comment">// Throw if doesn't look like valid key</span>
    <span class="keyword">if</span> (<span class="variable">value</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; !<span class="variable">samurayKeyRe</span>.<span class="variable">exec</span>(<span class="variable">value</span>)) {
      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Not a valid '</span> + <span class="variable">option</span>);  
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">value</span>) {
      <span class="variable">config</span>.<span class="variable">settings</span>[<span class="variable">option</span>] = <span class="variable">value</span>;
    }
    <span class="keyword">break</span>;
  <span class="keyword">case</span> <span class="string">'enabled'</span>:
  <span class="keyword">case</span> <span class="string">'debug'</span>:
    <span class="keyword">if</span> (<span class="variable">value</span>) {
      <span class="variable">config</span>.<span class="variable">settings</span>[<span class="variable">option</span>] = <span class="class">Boolean</span>(<span class="variable">value</span>);
    }
    <span class="keyword">break</span>;
  <span class="keyword">default</span>:
    <span class="keyword">if</span> (<span class="variable">value</span>) {
      <span class="variable">config</span>.<span class="variable">settings</span>[<span class="variable">option</span>] = <span class="variable">value</span>;
    }
    <span class="keyword">break</span>;
  }
  <span class="keyword">return</span> <span class="variable">config</span>.<span class="variable">settings</span>[<span class="variable">option</span>];
};

</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/daimyo.js"><a href="#">daimyo</a></h2></td><td>lib/daimyo.js</td></tr><tr class="code">
<td class="docs">
<h1>daimyo</h1>

<p>Copyright (c)2011, by Branko Vukelic <a href="mailto:branko@herdhound.com">branko@herdhound.com</a></p>

<p>Core Daimyo objects and functions. This module contains the core Daimyo API,
which is actually used by your application.</p>

<ul><li><strong>author</strong>: <em>Branko</em>
Vukelic <a href="mailto:branko@herdhound.com">branko@herdhound.com</a></li><li><strong>license</strong>: <em>MIT</em>
(see LICENSE)</li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">settings</span> = <span class="variable">require</span>(<span class="string">'./config'</span>).<span class="variable">settings</span>;
<span class="keyword">var</span> <span class="variable">debug</span> = <span class="variable">require</span>(<span class="string">'./config'</span>).<span class="variable">debug</span>;
<span class="keyword">var</span> <span class="variable">check</span> = <span class="variable">require</span>(<span class="string">'./check'</span>);
<span class="keyword">var</span> <span class="class">DaimyoError</span> = <span class="variable">require</span>(<span class="string">'./error'</span>);
<span class="keyword">var</span> <span class="variable">authpost</span> = <span class="variable">require</span>(<span class="string">'./authpost'</span>);
<span class="keyword">var</span> <span class="variable">xmlutils</span> = <span class="variable">require</span>(<span class="string">'./xmlutils'</span>);
<span class="keyword">var</span> <span class="variable">messages</span> = <span class="variable">require</span>(<span class="string">'./messages'</span>);
<span class="keyword">var</span> <span class="variable">tokenRe</span> = <span class="regexp">/^[0-9a-f]{24}$/</span>;
<span class="keyword">var</span> <span class="variable">daimyo</span> = <span class="variable">exports</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>daimyo.Card(opts)</h2>

<p><em>Creates a new payment method instance</em></p>

<p>The payment method options can be either a single token:
- <em>token</em>: Payment method token</p>

<p>or full credit card details:</p>

<ul><li><em>number</em>: Credit card number</li><li><em>csc</em>: Card security code</li><li><em>year</em>: Expiration year</li><li><em>month</em>: Expiration month</li><li><em>firstName</em>: Card holder's first name</li><li><em>lastName</em>: Card holder's last name</li><li><em>address1</em>: Address line 1</li><li><em>address2</em>: Address line 2</li><li><em>city</em>: City</li><li><em>state</em>: State</li><li><em>zip</em>: Zip code</li></ul>

<p>If you supply both token, and card details, token will take presedence, and 
credit card details will be completely ignored.</p>

<p>The constructor will refuse to accept credit card details if <code>number</code> and/or
<code>csc</code> properties are missing. An error will be thrown in such cases.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  opts Payment method options</p></li><li><p><strong>constructo</strong>: <em>r</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">Card</span>(<span class="variable">opts</span>) {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;

  <span class="comment">// This property contains the original/initial values of all fields</span>
  <span class="comment">// Do not motify this object directly. Use _dirty setter.</span>
  <span class="variable">self</span>.<span class="variable">_originalValues</span> = {
    <span class="variable">number</span>: <span class="variable">undefined</span>,
    <span class="variable">csc</span>: <span class="variable">undefined</span>,
    <span class="variable">year</span>: <span class="variable">undefined</span>,
    <span class="variable">month</span>: <span class="variable">undefined</span>,
    <span class="variable">firstName</span>: <span class="string">''</span>,
    <span class="variable">lastName</span>: <span class="string">''</span>,
    <span class="variable">address1</span>: <span class="string">''</span>,
    <span class="variable">address2</span>: <span class="string">''</span>,
    <span class="variable">city</span>: <span class="string">''</span>,
    <span class="variable">state</span>: <span class="string">''</span>,
    <span class="variable">zip</span>: <span class="string">''</span>
  };

  <span class="comment">// Update _originalValues keys if matching keys are found in object argument</span>
  <span class="variable">self</span>.<span class="variable">__defineSetter__</span>(<span class="string">'_dirty'</span>, <span class="keyword">function</span>(<span class="variable">object</span>) {
    <span class="class">Object</span>.<span class="variable">keys</span>(<span class="variable">self</span>.<span class="variable">_originalValues</span>).<span class="variable">forEach</span>(<span class="keyword">function</span>(<span class="variable">field</span>) {
      <span class="keyword">if</span> (<span class="variable">object</span>[<span class="variable">field</span>]) {
        <span class="variable">self</span>.<span class="variable">_originalValues</span>[<span class="variable">field</span>] = <span class="variable">object</span>[<span class="variable">field</span>];
      }
    });
  });

  <span class="comment">// Check fields for dirtiness and return the names of dirty fields as Array</span>
  <span class="variable">self</span>.<span class="variable">__defineGetter__</span>(<span class="string">'_dirty'</span>, <span class="keyword">function</span>() {
    <span class="keyword">var</span> <span class="variable">dirtyFields</span> = [];
   
    <span class="comment">// Check all fields in _originalValues and determine the dirty fields</span>
    <span class="class">Object</span>.<span class="variable">keys</span>(<span class="variable">self</span>.<span class="variable">_originalValues</span>).<span class="variable">forEach</span>(<span class="keyword">function</span>(<span class="variable">field</span>) {
      <span class="keyword">if</span> (<span class="variable">self</span>[<span class="variable">field</span>] !== <span class="variable">self</span>.<span class="variable">_originalValues</span>[<span class="variable">field</span>]) {
        <span class="variable">dirtyFields</span>.<span class="variable">push</span>(<span class="variable">field</span>);
      }
    });

    <span class="keyword">return</span> <span class="variable">dirtyFields</span>;
  });

  <span class="comment">// Setters and getters</span>

  <span class="variable">self</span>.<span class="variable">__defineSetter__</span>(<span class="string">'year'</span>, <span class="keyword">function</span>(<span class="variable">year</span>) {
    <span class="keyword">if</span> (!<span class="variable">year</span>) {
      <span class="keyword">return</span>;
    }

    <span class="variable">year</span> = <span class="variable">parseInt</span>(<span class="variable">year</span>, <span class="number integer">10</span>);
    <span class="keyword">if</span> (<span class="variable">year</span> &<span class="variable">lt</span>; <span class="number integer">10</span>) {
      <span class="variable">self</span>.<span class="variable">_year</span> = <span class="variable">normalizeYear</span>(<span class="number integer">10</span>, <span class="variable">year</span>);
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">year</span> &<span class="variable">gt</span>;= <span class="number integer">10</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">year</span> &<span class="variable">lt</span>; <span class="number integer">100</span>) {
      <span class="variable">self</span>.<span class="variable">_year</span> = <span class="variable">normalizeYear</span>(<span class="number integer">100</span>, <span class="variable">year</span>);
    } <span class="keyword">else</span> {
      <span class="variable">self</span>.<span class="variable">_year</span> = <span class="variable">year</span>;
    }
  });

  <span class="variable">self</span>.<span class="variable">__defineGetter__</span>(<span class="string">'year'</span>, <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="variable">self</span>.<span class="variable">_year</span>;
  });

  <span class="variable">self</span>.<span class="variable">__defineSetter__</span>(<span class="string">'month'</span>, <span class="keyword">function</span>(<span class="variable">month</span>) {
    <span class="variable">month</span> = <span class="variable">parseInt</span>(<span class="variable">month</span>, <span class="number integer">10</span>);
    <span class="keyword">if</span> (<span class="variable">isNaN</span>(<span class="variable">month</span>) || <span class="variable">month</span> &<span class="variable">lt</span>; <span class="number integer">1</span> || <span class="variable">month</span> &<span class="variable">gt</span>; <span class="number integer">12</span>) {
      <span class="variable">self</span>.<span class="variable">_month</span> = <span class="keyword">null</span>;
    } <span class="keyword">else</span> {
      <span class="variable">self</span>.<span class="variable">_month</span> = <span class="variable">month</span>;
    }
  });

  <span class="variable">self</span>.<span class="variable">__defineGetter__</span>(<span class="string">'month'</span>, <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="variable">self</span>.<span class="variable">_month</span>;
  });

  <span class="variable">self</span>.<span class="variable">__defineSetter__</span>(<span class="string">'number'</span>, <span class="keyword">function</span>(<span class="variable">value</span>) {
    <span class="variable">self</span>.<span class="variable">_number</span> = <span class="variable">check</span>.<span class="variable">extractDigits</span>(<span class="variable">value</span>);
    <span class="variable">self</span>.<span class="variable">issuer</span> = <span class="variable">check</span>.<span class="variable">getIssuer</span>(<span class="variable">value</span>);
  });

  <span class="variable">self</span>.<span class="variable">__defineGetter__</span>(<span class="string">'number'</span>, <span class="keyword">function</span>() {
    <span class="keyword">return</span> <span class="variable">self</span>.<span class="variable">_number</span>;
  });

  <span class="keyword">if</span> (<span class="variable">opts</span>) {
    <span class="keyword">if</span> (<span class="variable">opts</span>.<span class="variable">token</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">tokenRe</span>.<span class="variable">test</span>(<span class="variable">opts</span>.<span class="variable">token</span>)) {
      <span class="variable">debug</span>(<span class="string">'Using payment token instead of credit card details.'</span>);
      <span class="variable">self</span>.<span class="variable">token</span> = <span class="variable">opts</span>.<span class="variable">token</span>;
    } <span class="keyword">else</span> {
      <span class="variable">debug</span>(<span class="string">'No valid token found. Using credit card details.'</span>);
      <span class="variable">self</span>.<span class="variable">number</span> = <span class="variable">opts</span>.<span class="variable">number</span>;
      <span class="variable">self</span>.<span class="variable">csc</span> = <span class="variable">opts</span>.<span class="variable">csc</span>;

      <span class="comment">// Card number and CSC are required</span>
      <span class="keyword">if</span> (!<span class="variable">self</span>.<span class="variable">number</span>) {
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Card number is required'</span>);
      }
      <span class="keyword">if</span> (!<span class="variable">self</span>.<span class="variable">csc</span>) {
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'CSC is required'</span>);
      }

      <span class="variable">self</span>.<span class="variable">year</span> = <span class="variable">opts</span>.<span class="variable">year</span>;
      <span class="variable">self</span>.<span class="variable">month</span> = <span class="variable">parseInt</span>(<span class="variable">opts</span>.<span class="variable">month</span>, <span class="number integer">10</span>);
      <span class="variable">self</span>.<span class="variable">firstName</span> = <span class="variable">opts</span>.<span class="variable">firstName</span> || <span class="string">''</span>;
      <span class="variable">self</span>.<span class="variable">lastName</span> = <span class="variable">opts</span>.<span class="variable">lastName</span> || <span class="string">''</span>;
      <span class="variable">self</span>.<span class="variable">address1</span> = <span class="variable">opts</span>.<span class="variable">address1</span> || <span class="string">''</span>;
      <span class="variable">self</span>.<span class="variable">address2</span> = <span class="variable">opts</span>.<span class="variable">address2</span> || <span class="string">''</span>;
      <span class="variable">self</span>.<span class="variable">city</span> = <span class="variable">opts</span>.<span class="variable">city</span> || <span class="string">''</span>;
      <span class="variable">self</span>.<span class="variable">state</span> = <span class="variable">opts</span>.<span class="variable">state</span> || <span class="string">''</span>;
      <span class="variable">self</span>.<span class="variable">zip</span> = <span class="variable">opts</span>.<span class="variable">zip</span> || <span class="string">''</span>;

      <span class="comment">// Set card issuer</span>
      <span class="variable">self</span>.<span class="variable">issuer</span> = <span class="variable">check</span>.<span class="variable">getIssuer</span>(<span class="variable">self</span>.<span class="variable">number</span>) || <span class="string">''</span>;
    }
  }
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>daimyo.Card.isValid()</h2>

<p><em>Validate the card data</em></p>

<p>This method validates the correctness of the card number and CSC. It uses
the industry-standard Luhn Mod-10 check to ensure that the card number's 
checksum is correct. It also makes sure that the CSC has the correct number 
of digits (currently, AMEX cards have 4-digit CSC, while others use 3 
digits). </p>

<p>Note that the card may still fail to clear for any number of reasons. The
same check as this one is performed in the Samurai gateway, as well, however
if you create payment methods using server-to-server requests, rather than
letting Samurai create payment methods by submitting the payment form 
directly to Samurai, then this can speed up processing as you can trap
some common errors without sending a request to Samurai.</p>

<h2></h2>

<ul><li><p><strong>returns</strong>: <em>Boolean</em>  Validation result</p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Card</span>.<span class="variable">prototype</span>.<span class="variable">isValid</span> = <span class="keyword">function</span>() {
  <span class="keyword">if</span> (!<span class="variable">check</span>.<span class="variable">mod10check</span>(<span class="this">this</span>.<span class="variable">number</span>)) {
    <span class="keyword">return</span> <span class="variable">false</span>;
  }

  <span class="keyword">if</span> (!<span class="variable">check</span>.<span class="variable">cscCheck</span>(<span class="this">this</span>.<span class="variable">number</span>, <span class="this">this</span>.<span class="variable">csc</span>)) {
    <span class="keyword">return</span> <span class="variable">false</span>;
  }

  <span class="keyword">return</span> <span class="variable">true</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>daimyo.Card.isExpired()</h2>

<p>Checks the card expiration year/month</p>

<p>If the year and month are not specified, the check will return <code>true</code>. </p>

<p>This method does <em>not</em> correct the expiration year/month.</p>

<p>You should be aware that correcting the expiration year/month by setting 
them to a future date is acceptable practice, and banks will <em>not</em> decline
a card based on expiration year/month. If the card fails this test, you 
should manually forward the expiration date to increase the chance of the
transaction succeeding.</p>

<p>Note that the same check will be performed in Samurai gateway, but it is 
more efficient to do it yourself if you are not using the transparent 
redirect method as it saves at least one request.</p>

<h2></h2>

<ul><li><p><strong>returns</strong>: <em>Boolean</em>  Check result</p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Card</span>.<span class="variable">prototype</span>.<span class="variable">isExpired</span> = <span class="keyword">function</span>() {
  <span class="keyword">var</span> <span class="variable">expYear</span> = <span class="keyword">new</span> <span class="class">Date</span>().<span class="variable">getFullYear</span>();
  <span class="keyword">var</span> <span class="variable">expMonth</span> = <span class="keyword">new</span> <span class="class">Date</span>().<span class="variable">getMonth</span>() + <span class="number integer">1</span>; <span class="comment">// 0-indexed</span>

  <span class="keyword">if</span> (!<span class="this">this</span>.<span class="variable">year</span> || !<span class="this">this</span>.<span class="variable">month</span>) { <span class="keyword">return</span> <span class="variable">true</span>; }

  <span class="comment">// Expired card should not be last month this year or older</span>
  <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">year</span> &<span class="variable">lt</span>; <span class="variable">expYear</span>) { <span class="keyword">return</span> <span class="variable">true</span>; }
  <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">year</span> === <span class="variable">expYear</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="this">this</span>.<span class="variable">month</span> &<span class="variable">lt</span>; <span class="variable">expMonth</span>) { <span class="keyword">return</span> <span class="variable">true</span>; }

  <span class="keyword">return</span> <span class="variable">false</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>daimyo.Card.create(callback)</h2>

<p><em>Sends a request to create a new payment method</em></p>

<p>Creates a new payment method in the Samurai vault, and sets the <code>token</code> 
property to the received payment method token.</p>

<p>The callback should accept a single error object that is <code>null</code> if 
no error occured.</p>

<h2>Example</h2>

<pre><code>var cardData = {...};
var card = new daimyo.Card(cardData);
card.create(function(err) {
  if (err) {
    console.log(err);
    return;
  }
  console.log('Payment token: ' + card.token);
});</code></pre>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  Optional callback function (expects err)</p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Card</span>.<span class="variable">prototype</span>.<span class="variable">create</span> = <span class="keyword">function</span>(<span class="variable">callback</span>) {
  <span class="keyword">var</span> <span class="variable">querystring</span> = <span class="variable">require</span>(<span class="string">'querystring'</span>);
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;
  <span class="keyword">var</span> <span class="variable">paymentTokenRe</span> = <span class="regexp">/payment_method_token=([0-9a-f]{24})/</span>;
  <span class="keyword">var</span> <span class="variable">msgRe</span> = <span class="regexp">/&lt;message[^&gt;]*&gt;([^&lt;]*)&lt;\/message</span>&<span class="variable">gt</span>;/;

  <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">token</span>) {
    <span class="variable">callback</span>(<span class="keyword">null</span>, <span class="this">this</span>.<span class="variable">token</span>);
    <span class="keyword">return</span>;
  }

  <span class="comment">// Reformat our data as required by the API</span>
  <span class="variable">paymentData</span> = <span class="variable">querystring</span>.<span class="variable">stringify</span>({
    <span class="string">'redirect_url'</span>: <span class="string">'http://example.com'</span>, <span class="comment">// Bogus URL, required by API</span>
    <span class="string">'merchant_key'</span>: <span class="variable">settings</span>.<span class="variable">merchantKey</span>,
    <span class="string">'credit_card[first_name]'</span>: <span class="this">this</span>.<span class="variable">firstName</span> || <span class="string">''</span>,
    <span class="string">'credit_card[last_name]'</span>: <span class="this">this</span>.<span class="variable">lastName</span> || <span class="string">''</span>,
    <span class="string">'credit_card[address_1]'</span>: <span class="this">this</span>.<span class="variable">address1</span> || <span class="string">''</span>,
    <span class="string">'credit_card[address_2]'</span>: <span class="this">this</span>.<span class="variable">address2</span> || <span class="string">''</span>,
    <span class="string">'credit_card[city]'</span>: <span class="this">this</span>.<span class="variable">city</span> || <span class="string">''</span>,
    <span class="string">'credit_card[state]'</span>: <span class="this">this</span>.<span class="variable">state</span> || <span class="string">''</span>,
    <span class="string">'credit_card[zip]'</span>: <span class="this">this</span>.<span class="variable">zip</span> || <span class="string">''</span>,
    <span class="string">'credit_card[card_type]'</span>:  <span class="this">this</span>.<span class="variable">issuer</span> || <span class="string">''</span>,
    <span class="string">'credit_card[card_number]'</span>: <span class="this">this</span>.<span class="variable">number</span> || <span class="string">''</span>,
    <span class="string">'credit_card[cvv]'</span>: <span class="this">this</span>.<span class="variable">csc</span> || <span class="string">''</span>,
    <span class="string">'credit_card[expiry_month]'</span>: <span class="this">this</span>.<span class="variable">month</span> || <span class="string">''</span>,
    <span class="string">'credit_card[expiry_year]'</span>: <span class="this">this</span>.<span class="variable">year</span> || <span class="string">''</span>
  });

  <span class="variable">authpost</span>.<span class="variable">makeRequest</span>({
    <span class="variable">method</span>: <span class="string">'POST'</span>,
    <span class="variable">payload</span>: <span class="variable">paymentData</span>
  }, <span class="keyword">function</span>(<span class="variable">err</span>, <span class="variable">res</span>) {
    <span class="keyword">var</span> <span class="variable">errMsg</span>;

    <span class="keyword">if</span> (<span class="variable">err</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">err</span> <span class="variable">instanceof</span> <span class="class">DaimyoError</span>) {
      <span class="variable">callback</span>(<span class="variable">err</span>);
    }
    <span class="keyword">if</span> (<span class="variable">err</span>) {
      <span class="variable">callback</span>(<span class="keyword">new</span> <span class="class">DaimyoError</span>(<span class="string">'system'</span>, <span class="string">'Error making create payment method request'</span>, <span class="variable">err</span>));
      <span class="keyword">return</span>;
    }
    <span class="keyword">if</span> (<span class="variable">res</span>.<span class="variable">status</span> !== <span class="number integer">302</span>) {
      <span class="comment">// Parse the body to find the error</span>
      <span class="variable">errMsg</span> = <span class="variable">msgRe</span>.<span class="variable">exec</span>(<span class="variable">res</span>.<span class="variable">body</span>)[<span class="number integer">1</span>];
      <span class="variable">callback</span>(<span class="keyword">new</span> <span class="class">DaimyoError</span>(<span class="string">'system'</span>, <span class="string">'Gateway responded with non-302 status'</span>, {<span class="variable">status</span>: <span class="variable">res</span>.<span class="variable">status</span>, <span class="variable">message</span>: <span class="variable">errMsg</span>}));
      <span class="keyword">return</span>;
    }
    <span class="keyword">if</span> (!<span class="variable">res</span>.<span class="variable">headers</span>.<span class="variable">location</span>) {
      <span class="variable">callback</span>(<span class="keyword">new</span> <span class="class">DaimyoError</span>(<span class="string">'system'</span>, <span class="string">'Gateway failed to send the location header'</span>, <span class="variable">res</span>.<span class="variable">headers</span>));
      <span class="keyword">return</span>;
    }

    <span class="comment">// Parse the location header to extract the token</span>
    <span class="variable">self</span>.<span class="variable">token</span> = <span class="variable">paymentTokenRe</span>.<span class="variable">exec</span>(<span class="variable">res</span>.<span class="variable">headers</span>.<span class="variable">location</span>)[<span class="number integer">1</span>];
    <span class="variable">self</span>.<span class="variable">_resetDirty</span>();
    <span class="variable">callback</span>(<span class="keyword">null</span>);
  });
 
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>daimyo.Card.load(callback)</h2>

<p><em>Load payment method data from Samurai server</em></p>

<p>This method is used to load a created/retained payment method from the 
Samurai gateway. The returned data immediately updates the fields in the
card instance, and also creates a new <code>method</code> property, which contains 
metadata about the payment method.</p>

<p>The <code>method</code> property has the following properties:</p>

<ul><li><em>valid</em>: Whether the card has passed Samurai's validation (this is the 
same type of validation as those used in <code>isValid()</code> method.</li><li><em>updatedAt</em>: The timestamp of payment method's last modification</li><li><em>createdAt</em>: Payment method creation timestamp</li><li><em>retained</em>: Whether payment method is permanent</li><li><em>redacted</em>: Whether payment mehtod was modified</li><li><em>custom</em>: Custom fields (setting them is not yet supported by Daimyo)</li></ul>

<p><code>load</code> method also creates a <code>messages</code> property which contains any 
messages that the gateway emitted. These may include validation errors. </p>

<p>The callback should expect a single error object.</p>

<h2>Example</h2>

<pre><code>// E.g., you have a payment token stored in a database
var userToken = 'xxxxxxxxxxxxxxxxxxxxxxxx';
var card = new daimyo.Card({token: userToken});
card.load(function(err) {
   // Now card's fields are populated with billing details
});</code></pre>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  callback Expects err object</p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Card</span>.<span class="variable">prototype</span>.<span class="variable">load</span> = <span class="keyword">function</span>(<span class="variable">callback</span>) {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;

  <span class="variable">self</span>.<span class="variable">_rejectNoToken</span>();

  <span class="variable">self</span>.<span class="variable">_executeRequest</span>({
    <span class="variable">path</span>: <span class="variable">self</span>.<span class="variable">_getTokenPath</span>()
  }, <span class="variable">callback</span>);

};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>daimyo.Card.update(callback)</h2>

<p><em>Update payment method with modified data</em></p>

<p>After changing the properties of a card object, you can call this method
to sync the data with the Samurai gateway. This method is 'smart' enough
to not waste bandwidth when there are no changed properties, so if the 
if you allow users to edit the data, you don't need to check if they have
entered anything new. It also sends only the changed fields.</p>

<p>Once the update is complete, all fields will be marked as clean.</p>

<p>The callback should expect a single error object.</p>

<h2>Example</h2>

<pre><code>// You load the card from Samurai using the load() method
var loadedCard;
// User makes modification to data
loadedCard.firstName = 'Foo';
// Now you can update it
loadedCard.update(function(err) {
   // The payment method is now updated
});</code></pre>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  callback Called with err object</p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Card</span>.<span class="variable">prototype</span>.<span class="variable">update</span> = <span class="keyword">function</span>(<span class="variable">callback</span>) {
  <span class="keyword">var</span> <span class="variable">updatedFields</span> = {};
  <span class="keyword">var</span> <span class="variable">payload</span> = <span class="string">''</span>;
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;

  <span class="variable">self</span>.<span class="variable">_rejectNoToken</span>();

  <span class="comment">// If nothing was updated, just call the callback and pretend it was updated</span>
  <span class="keyword">if</span> (!<span class="variable">self</span>.<span class="variable">_dirty</span>.<span class="variable">length</span>) {
    <span class="variable">callback</span>(<span class="keyword">null</span>);
    <span class="keyword">return</span>;
  }

  <span class="comment">// Get all dirty fields</span>
  <span class="variable">self</span>.<span class="variable">_dirty</span>.<span class="variable">forEach</span>(<span class="keyword">function</span>(<span class="variable">field</span>) {
    <span class="variable">updatedFields</span>[<span class="variable">field</span>] = <span class="variable">self</span>[<span class="variable">field</span>];
  });

  <span class="comment">// We have to rename a few fields</span>
  <span class="variable">updatedFields</span> = <span class="variable">daimyo</span>.<span class="variable">toSamurai</span>(<span class="variable">updatedFields</span>);

  <span class="comment">// Construct the XML payload</span>
  <span class="variable">payload</span> = <span class="variable">xmlutils</span>.<span class="variable">toXML</span>(<span class="variable">updatedFields</span>, <span class="string">'payment_method'</span>);

  <span class="variable">self</span>.<span class="variable">_executeRequest</span>({
    <span class="variable">path</span>: <span class="variable">self</span>.<span class="variable">_getTokenPath</span>(),
    <span class="variable">method</span>: <span class="string">'PUT'</span>,
    <span class="variable">payload</span>: <span class="variable">payload</span>
  }, <span class="variable">callback</span>);

};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>daimyo.Card.retain()</h2>

<p><em>Instructs Samurai to ratain (save permanently) the payment method</em></p>

<p>This is simple method that makes the payment method permanent on the 
gateway. The payment method will be stored for future use after this method
is called.</p>

<p>By default, payment method that hasn't been retained will be deleted after
48 hours. You can delete a payment method (redact in Samurai parlance) at 
any time by calling the <code>redact()</code> method.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  callback Called with err object</p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Card</span>.<span class="variable">prototype</span>.<span class="variable">retain</span> = <span class="keyword">function</span>(<span class="variable">callback</span>) {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;

  <span class="variable">self</span>.<span class="variable">_rejectNoToken</span>();

  <span class="variable">self</span>.<span class="variable">_executeRequest</span>({
    <span class="variable">path</span>: <span class="variable">self</span>.<span class="variable">_getTokenPath</span>(<span class="string">'/retain'</span>),
    <span class="variable">method</span>: <span class="string">'POST'</span>
  }, <span class="variable">callback</span>);

};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>daimyo.Card.redact()</h2>

<p><em>Instructs Samurai to redact (delete) the payment method</em></p>

<p>When a user wants to use a new card, you should always redact (delete) the
existing payment method before accepting the new card. An alternative way is 
to update the existing card by modifying the billing/card data using the
<code>update()</code> method.</p>

<p>Updating a card is usually more efficient, as it requires only one request.</p>

<p>Note that the card that is redacted will still have the <code>retained</code> flag 
set to true in the <code>method</code> property. You should not, and cannot keep 
using the redacted payment method for transactions.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Function</em>  callback Called with err object</p></li></ul>
</td>
<td class="code">
<pre><code><span class="class">Card</span>.<span class="variable">prototype</span>.<span class="variable">redact</span> = <span class="keyword">function</span>(<span class="variable">callback</span>) {
  <span class="keyword">var</span> <span class="variable">self</span> = <span class="this">this</span>;

  <span class="variable">self</span>.<span class="variable">_rejectNoToken</span>();

  <span class="variable">self</span>.<span class="variable">_executeRequest</span>({
    <span class="variable">path</span>: <span class="variable">self</span>.<span class="variable">_getTokenPath</span>(<span class="string">'/redact'</span>),
    <span class="variable">method</span>: <span class="string">'POST'</span>
  }, <span class="variable">callback</span>);

};

<span class="variable">daimyo</span>.<span class="class">Card</span> = <span class="class">Card</span>;
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/check.js"><a href="#">check</a></h2></td><td>lib/check.js</td></tr><tr class="code">
<td class="docs">
<h1>check</h1>

<p>Copyright (c)2011, by Branko Vukelic <a href="mailto:branko@herdhound.com">branko@herdhound.com</a></p>

<p>This module contains functions for performing various credit card checks.
The checks it performs are:</p>

<ul><li>Luhn Mod-10 check (verifies if card number is valid)</li><li>CSC check (verifies if the CSC/CVV/CCV number has correct number of 
digits)</li><li>Issuer check (determines the issuer of the card)</li></ul>

<p>This module can be converted for use in browsers by using the <code>checkamd</code> 
target in the makefile:</p>

<pre><code>make checkamd</code></pre>

<p>The above command converts this module into an AMD module loadable with
AMD-compliant loaders like <a href="http://requirejs.org/">RequireJS</a>.</p>

<ul><li><strong>author</strong>: <em>Branko</em>
Vukelic <a href="mailto:branko@herdhound.com">branko@herdhound.com</a></li><li><strong>license</strong>: <em>MIT</em>
(see LICENSE)</li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">check</span> = <span class="variable">exports</span>;
<span class="keyword">var</span> <span class="class">NON_DIGIT_CHARS</span> = <span class="regexp">/[^\d]+/</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>check.issuers</h2>

<p><em>Issuer names with regexes for checking the card numbers and CSCs</em></p>

<p>Issuer check regexes are currently based on the following resources: </p>

<ul><li><a href="http://www.merriampark.com/anatomycc.htm">Anatomy of Credit Card Numbers</a></li><li><a href="http://en.wikipedia.org/wiki/Credit_card_numbers">Wikipedia article</a></li></ul>

<p>These regexes are bound to change as issuers landscape changes over time.
They are also not meant to be comprehensive Issuer check. They are meant to
catch major cards for further CVC (CCV) check.</p>

<p>Currently, the following issuers are detected by this module:</p>

<ul><li>Visa</li><li>MasterCard</li><li>American Express</li><li>Diners Club</li><li>Discover</li><li>JCB (Japan Credit Bureau)</li><li>China UnionPay</li></ul>

<p>Note that China UnionPay cards <em>will</em> fail the Luhn Mod-10 check.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">check</span>.<span class="variable">issuers</span> = {
  <span class="class">VISA</span>: [<span class="string">'Visa'</span>, <span class="regexp">/^4(\d{12}|\d{15})$/</span>, <span class="regexp">/^\d{3}$/</span>],
  <span class="class">MAST</span>: [<span class="string">'MasterCard'</span>, <span class="regexp">/^5[1-5]\d{14}$/</span>, <span class="regexp">/^\d{3}$/</span>],
  <span class="class">AMEX</span>: [<span class="string">'American Express'</span>, <span class="regexp">/^3[47]\d{13}$/</span>, <span class="regexp">/^\d{4}$/</span>],
  <span class="class">DINA</span>: [<span class="string">'Diners Club'</span>, <span class="regexp">/^3(00|05|6\d|8\d)\d{11}$/</span>, <span class="regexp">/^\d{3}$/</span>],
  <span class="class">DISC</span>: [<span class="string">'Discover'</span>, <span class="regexp">/^(622[1-9]|6011|64[4-9]\d|65\d{2})\d{12}$/</span>, <span class="regexp">/^\d{3}$/</span>], 
  <span class="class">JCB</span>: [<span class="string">'JCB'</span>, <span class="regexp">/^35(28|29|[3-8]\d)\d{12}$/</span>, <span class="regexp">/^\d{3}$/</span>], 
  <span class="class">CHIN</span>: [<span class="string">'China UnionPay'</span>, <span class="regexp">/^62\d{14}/</span>, <span class="regexp">/^\d{3}$/</span>]
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>check.extractDigits(s)</h2>

<p><em>Removes all non-digit characters from a given string</em></p>

<p>This function replaces all non-digit strings with an empty string. The 
resulting string contains only digits.</p>

<p><code>check.extractDigits()</code> is used throughout the <code>check</code> module to make sure 
that the card numbers and CSCs are parsed correctly.</p>

<h2>Example</h2>

<pre><code>var n = '1234-5678-1234-5678';
console.log(check.extractDigits(n);
// outputs: '1234567812345678'
n = 'abcd';
console.log(check.extractDigits(n);
// outputs: ''</code></pre>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  s String to operate on</p></li><li><p><strong>returns</strong>: <em>String</em>  String with stripped out non-digit characters</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">check</span>.<span class="variable">extractDigits</span> = <span class="keyword">function</span>(<span class="variable">s</span>) {
  <span class="keyword">return</span> <span class="variable">s</span>.<span class="variable">replace</span>(<span class="class">NON_DIGIT_CHARS</span>, <span class="string">''</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>check.getIssuer(card, [full])</h2>

<p>Returns the issuer of the card</p>

<p>The card number is stripped of any non-digit characters prior to checking. 
The <code>full</code> flag can be used to retrieve all issuer detauls (regex for 
checking card numbers and CSC) or just the issuer name.</p>

<h2>Example</h2>

<pre><code>check.getIssuer('4111111111111111');
// returns: 'Visa'
check.getIssuer('4111111111111111', true);
// returns: ['Visa', /^4(\d{12}|\d{15})$/, /^\d{3}$/]</code></pre>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  card Card number</p></li><li><p><strong>param</strong>: <em>Boolean</em>  [full] Whether to return the issuer details instead of name</p></li><li><p><strong>returns</strong>: <em>String</em>  String representing the issuer name</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">check</span>.<span class="variable">getIssuer</span> = <span class="keyword">function</span>(<span class="variable">card</span>, <span class="variable">full</span>) {
  <span class="keyword">var</span> <span class="variable">lastMatch</span> = <span class="variable">full</span> ? [<span class="string">'Unknown'</span>, <span class="regexp">/^\d{16}$/</span>, <span class="regexp">/^\d{3}$/</span>] : <span class="string">'Unknown'</span>;
  <span class="variable">card</span> = <span class="variable">check</span>.<span class="variable">extractDigits</span>(<span class="variable">card</span>);
  <span class="keyword">if</span> (!<span class="variable">card</span>) {
    <span class="keyword">return</span> <span class="string">'Unknown'</span>;
  }
  <span class="class">Object</span>.<span class="variable">keys</span>(<span class="variable">check</span>.<span class="variable">issuers</span>).<span class="variable">forEach</span>(<span class="keyword">function</span>(<span class="variable">issuer</span>) {
    <span class="keyword">if</span> (<span class="variable">check</span>.<span class="variable">issuers</span>[<span class="variable">issuer</span>][<span class="number integer">1</span>].<span class="variable">test</span>(<span class="variable">card</span>)) {
      <span class="variable">lastMatch</span> = <span class="variable">full</span> ? <span class="variable">check</span>.<span class="variable">issuers</span>[<span class="variable">issuer</span>] : <span class="variable">check</span>.<span class="variable">issuers</span>[<span class="variable">issuer</span>][<span class="number integer">0</span>];
    }
  });
  <span class="keyword">return</span> <span class="variable">lastMatch</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>check.mod10check(card)</h2>

<p><em>Checks the validity of credit card using the Luhn Mod-10 algorithm</em></p>

<p>The card number is checked after all non-digit characters are removed from
the original string. If the check succeeds, the sanitized number is 
returned. Otherwise, <code>null</code> is returned.</p>

<p>Please note that China UnionPay cards always fail the Luhn Mod-10 check. If 
you need to support China UnionPay cards, you need to make an exception for 
them when validating the card number:</p>

<pre><code>if (check.getIssuer(cardNumber) === 'China UnionPay') {
  return cardNumber;
} else {
  return check.mod10check(cardNumber);
}</code></pre>

<p>Since we have no access to valid test numbers for China UnionPay cards, we
don't know if Samurai gateway itself will accept them.</p>

<h2>Example</h2>

<pre><code>check.mod10check('4111-1111-1111-1111');
// returns: '4111111111111111'
check.mod10check('123-bogus');
// returns: null
check.mod10check();
// returns: null</code></pre>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  card Card number in string format</p></li><li><p><strong>return</strong>: <em>Object</em>  Sanitized number if valid, otherwise <code>null</code></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">check</span>.<span class="variable">mod10check</span> = <span class="keyword">function</span>(<span class="variable">card</span>) {
    <span class="keyword">var</span> <span class="variable">sum</span> = <span class="number integer">0</span>;
    <span class="keyword">var</span> <span class="variable">totalDigits</span>;
    <span class="keyword">var</span> <span class="variable">oddEven</span>;
    <span class="keyword">var</span> <span class="variable">digits</span>;
    <span class="keyword">var</span> <span class="variable">i</span>;
    <span class="keyword">var</span> <span class="variable">current</span>;

    <span class="variable">card</span> = <span class="variable">check</span>.<span class="variable">extractDigits</span>(<span class="variable">card</span>);  

    <span class="keyword">if</span> (!<span class="variable">card</span>) {
      <span class="comment">// Card number contains no digits</span>
      <span class="keyword">return</span> <span class="keyword">null</span>;
    }

    <span class="variable">totalDigits</span> = <span class="variable">card</span>.<span class="variable">length</span>;
    <span class="variable">oddEven</span> = <span class="variable">totalDigits</span> &<span class="variable">amp</span>; <span class="number integer">1</span>;
    <span class="variable">digits</span> = <span class="variable">card</span>.<span class="variable">split</span>(<span class="string">''</span>); <span class="comment">// Convert to array</span>

    <span class="keyword">for</span> (<span class="variable">i</span> = <span class="variable">totalDigits</span>; <span class="variable">i</span>; --<span class="variable">i</span>) {
      <span class="variable">current</span> = <span class="variable">totalDigits</span> - <span class="variable">i</span>; 
      <span class="variable">digit</span> = <span class="variable">parseInt</span>(<span class="variable">digits</span>[<span class="variable">current</span>], <span class="number integer">10</span>);

      <span class="keyword">if</span> (!((<span class="variable">current</span> &<span class="variable">amp</span>; <span class="number integer">1</span>) ^ <span class="variable">oddEven</span>)) {
        <span class="variable">digit</span> = <span class="variable">digit</span> * <span class="number integer">2</span>;
      }
      <span class="keyword">if</span> (<span class="variable">digit</span> &<span class="variable">gt</span>; <span class="number integer">9</span>) {
        <span class="variable">digit</span> -= <span class="number integer">9</span>;
      }

      <span class="variable">sum</span> = <span class="variable">sum</span> + <span class="variable">digit</span>;
    }

    <span class="keyword">return</span> (<span class="variable">sum</span> % <span class="number integer">10</span>) === <span class="number integer">0</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">card</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>check.cscCheck(card, csc)</h2>

<p><em>Checks the card security code (CSC) given card number and the code</em></p>

<p>Card number is required because the CSC is not the same format for all 
issuers. Currently, American Express cards have a 4-digit CSC, while all 
other issuers (that we know of) have a 3-digit CSC.</p>

<h2>Example</h2>

<pre><code>check.cscCheck('4111111111111111', '111');
// returns: true
check.cscCheck('4111111111111111', '11');
// returns: false</code></pre>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  card Credit card number</p></li><li><p><strong>param</strong>: <em>String</em>  csc Card security code</p></li><li><p><strong>returns</strong>: <em>Boolean</em>  Boolean value of the test status</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">check</span>.<span class="variable">cscCheck</span> = <span class="keyword">function</span>(<span class="variable">card</span>, <span class="variable">csc</span>) {
  <span class="keyword">var</span> <span class="variable">issuerDetails</span>;

  <span class="variable">csc</span> = <span class="variable">check</span>.<span class="variable">extractDigits</span>(<span class="variable">csc</span>);
  <span class="keyword">if</span> (!<span class="variable">csc</span>) { <span class="keyword">return</span> <span class="variable">false</span>; }

  <span class="variable">issuerDetails</span> = <span class="variable">check</span>.<span class="variable">getIssuer</span>(<span class="variable">card</span>, <span class="variable">true</span>);
  <span class="keyword">return</span> <span class="variable">issuerDetails</span>[<span class="number integer">2</span>].<span class="variable">test</span>(<span class="variable">csc</span>);
};
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/xmlutils.js"><a href="#">xmlutils</a></h2></td><td>lib/xmlutils.js</td></tr><tr class="code">
<td class="docs">
<p>Daimyo - utilities for dealing with XML
Copyright (c)2011, by Branko Vukelic <a href="mailto:branko@herdhound.com">branko@herdhound.com</a>
Licensed under MIT license (see LICENSE)
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">xmlutils</span> = <span class="variable">exports</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Convert a string to integer</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  s String to be parsed</p></li><li><p><strong>returns</strong>: <em>Integer</em>  Converted integer</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">xmlutils</span>.<span class="variable">toInt</span> = <span class="keyword">function</span>(<span class="variable">s</span>) {
  <span class="keyword">return</span> <span class="variable">parseInt</span>(<span class="variable">s</span>, <span class="number integer">10</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Convert a string to Date object</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  s String to be parsed</p></li><li><p><strong>returns</strong>: <em>Date</em>  Converted date</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">xmlutils</span>.<span class="variable">toDate</span> = <span class="keyword">function</span>(<span class="variable">s</span>) {
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="class">Date</span>(<span class="variable">s</span>);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Convert a string to Bool</p>

<p>This function treats <code>'true'</code> as <code>true</code>, and everything else as false.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  s String to be parsed</p></li><li><p><strong>returns</strong>: <em>Bool</em>  Converted boolean</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">xmlutils</span>.<span class="variable">toBool</span> = <span class="keyword">function</span>(<span class="variable">s</span>) {
  <span class="keyword">return</span> <span class="variable">s</span> === <span class="string">'true'</span> ? <span class="variable">true</span> : <span class="variable">false</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Pass-through function that does nothing</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  s Strning to be passed through</p></li><li><p><strong>returns</strong>: <em>String</em>  Same string that came in</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">xmlutils</span>.<span class="variable">toString</span> = <span class="keyword">function</span>(<span class="variable">s</span>) {
  <span class="keyword">return</span> <span class="variable">s</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Extract data from XML string using recipe mappings</p>

<p>Recipe object contains a mapping between tag names and coercion functions 
like <code>toInt</code> and <code>toDate</code>. Each key in the recipe object will be treated
as a valid tag name, and searched for within the XML. Data found within the 
XML string will be coerced and assigned to a key in the result object. The
key name in the result object will match the key name from the recipe 
object.</p>

<p>An example recipe object:</p>

<pre><code>{
  'payment_method_token': xmlutils.toString,
  'created_at': xmlutils.toDate,
  ....
}</code></pre>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  xml The source XML string</p></li><li><p><strong>param</strong>: <em>Object</em>  recipe The recipe object</p></li><li><p><strong>returns</strong>: <em>Object</em>  Name-value pairs of extracted data</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">xmlutils</span>.<span class="variable">extractData</span> = <span class="keyword">function</span>(<span class="variable">xml</span>, <span class="variable">recipe</span>) {
  <span class="keyword">var</span> <span class="variable">result</span> = {};
  <span class="class">Object</span>.<span class="variable">keys</span>(<span class="variable">recipe</span>).<span class="variable">forEach</span>(<span class="keyword">function</span>(<span class="variable">key</span>) {
    <span class="comment">// Get the Regex for the recipe</span>
    <span class="keyword">var</span> <span class="variable">rxp</span> = <span class="variable">getTagRe</span>(<span class="variable">key</span>);
    <span class="keyword">var</span> <span class="variable">matches</span> = <span class="variable">matchAll</span>(<span class="variable">xml</span>, <span class="variable">rxp</span>);

    <span class="keyword">if</span> (<span class="variable">matches</span>.<span class="variable">length</span> === <span class="number integer">1</span>) {
      <span class="variable">result</span>[<span class="variable">key</span>] = <span class="variable">recipe</span>[<span class="variable">key</span>](<span class="variable">matches</span>[<span class="number integer">0</span>]);
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">matches</span>.<span class="variable">length</span> &<span class="variable">gt</span>; <span class="number integer">1</span>) {
      <span class="variable">result</span>[<span class="variable">key</span>] = [];
      <span class="variable">matches</span>.<span class="variable">forEach</span>(<span class="keyword">function</span>(<span class="variable">match</span>) {
        <span class="variable">result</span>[<span class="variable">key</span>].<span class="variable">push</span>(<span class="variable">recipe</span>[<span class="variable">key</span>](<span class="variable">match</span>));
      });
    }
  });

  <span class="keyword">return</span> <span class="variable">result</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>xmlutils.hasMessages(xml)</h2>

<p><em>Checks the XML to see if there is a <code>&lt;messsages&gt;</code> block</em></p>

<p>Returns <code>true</code> if there is a <code>&lt;messages&gt;</code> block.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  xml The XML string</p></li><li><p><strong>returns</strong>: <em>Boolean</em>  Whether it found the <code>&lt;messages&gt;</code> block</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">xmlutils</span>.<span class="variable">hasMessages</span> = <span class="keyword">function</span>(<span class="variable">xml</span>) {
  <span class="keyword">return</span> <span class="class">Boolean</span>((<span class="regexp">/&lt;messages[^&gt;]*&gt;/</span>).<span class="variable">exec</span>(<span class="variable">xml</span>));
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Extract messages from XML string</p>

<p>The messages can be of the following classes:
- <em>error</em>: errors and declines
- <em>info</em>: success and other information</p>

<p>The messages will also have a context in which it was transmitted, and the 
message that describes the details.</p>

<p>The return object may look like this:</p>

<pre><code>{
  error: [{'input.card_number': 'failed_checksum'}]
}</code></pre>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  xml The XML string to be parsed</p></li><li><p><strong>returns</strong>: <em>Array</em>  Array of error messages.</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">xmlutils</span>.<span class="variable">extractMessages</span> = <span class="keyword">function</span>(<span class="variable">xml</span>) {
  <span class="keyword">var</span> <span class="variable">messageRe</span> = <span class="regexp">/&lt;message ([^&gt;]+)&gt;/g</span>;
  <span class="keyword">var</span> <span class="variable">classRe</span> = <span class="regexp">/class=&quot;([^&quot;]+)&quot;/</span>;
  <span class="keyword">var</span> <span class="variable">contextRe</span> = <span class="regexp">/context=&quot;([^&quot;]+)&quot;/</span>;
  <span class="keyword">var</span> <span class="variable">keyRe</span> = <span class="regexp">/key=&quot;([^&quot;]+)&quot;/</span>;
  <span class="keyword">var</span> <span class="variable">attrs</span>;
  <span class="keyword">var</span> <span class="variable">message</span>;
  <span class="keyword">var</span> <span class="variable">messages</span> = [];
  <span class="keyword">var</span> <span class="variable">match</span> = <span class="variable">messageRe</span>.<span class="variable">exec</span>(<span class="variable">xml</span>);

  <span class="keyword">while</span>(<span class="variable">match</span>) {
    <span class="variable">attrs</span> = <span class="variable">match</span>[<span class="number integer">1</span>];
    <span class="variable">message</span> = {};
    <span class="variable">message</span>.<span class="variable">cls</span> = <span class="variable">classRe</span>.<span class="variable">exec</span>(<span class="variable">attrs</span>)[<span class="number integer">1</span>];
    <span class="variable">message</span>.<span class="variable">context</span> = <span class="variable">contextRe</span>.<span class="variable">exec</span>(<span class="variable">attrs</span>)[<span class="number integer">1</span>];
    <span class="variable">message</span>.<span class="variable">key</span> = <span class="variable">keyRe</span>.<span class="variable">exec</span>(<span class="variable">attrs</span>)[<span class="number integer">1</span>];
    <span class="variable">messages</span>.<span class="variable">push</span>(<span class="variable">message</span>);
    <span class="variable">match</span> = <span class="variable">messageRe</span>.<span class="variable">exec</span>(<span class="variable">xml</span>);
  }

  <span class="keyword">return</span> <span class="variable">messages</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Decamelizes a string</p>

<p>Converts 'CamelCase' to 'camel_case'.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  s String to convert</p></li><li><p><strong>returns</strong>: <em>String</em>  Decamelized string</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">xmlutils</span>.<span class="variable">decamelize</span> = <span class="keyword">function</span>(<span class="variable">s</span>) {
  <span class="variable">s</span> = <span class="variable">s</span>.<span class="variable">replace</span>(<span class="regexp">/^[A-Z]/</span>, <span class="keyword">function</span>(<span class="variable">match</span>) {
    <span class="keyword">return</span> <span class="variable">match</span>.<span class="variable">toLowerCase</span>();
  });
  <span class="variable">s</span> = <span class="variable">s</span>.<span class="variable">replace</span>(<span class="regexp">/[A-Z]/g</span>, <span class="keyword">function</span>(<span class="variable">match</span>) {
    <span class="keyword">return</span> <span class="string">'_'</span> + <span class="variable">match</span>.<span class="variable">toLowerCase</span>();
  });
  <span class="keyword">return</span> <span class="variable">s</span>;
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Shallow conversion of JavaScript object to XML</p>

<p>It converts each key to a single XML node and converts the contents of the 
key to a text node by calling <code>toString</code> on it.</p>

<p>Optionally, the whole XML string can be wrapped in a top-level tag.</p>

<p>This function <em>does not</em> care about the order of keys, so if you need the
nodes to be in a certain order, you should supply an array of keys.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  o Object to be converted</p></li><li><p><strong>param</strong>: <em>String</em>  [topLevel] Top level tag</p></li><li><p><strong>param</strong>: <em>Array</em>  [keys] Array of keys to use so that nodes are ordered</p></li><li><p><strong>returns</strong>: <em>String</em>  XML version of the object</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">xmlutils</span>.<span class="variable">toXML</span> = <span class="keyword">function</span>(<span class="variable">o</span>, <span class="variable">topLevel</span>, <span class="variable">keys</span>) {
  <span class="keyword">var</span> <span class="variable">xml</span> = <span class="string">''</span>;

  <span class="comment">// Was topLevel arg skipped?</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable">topLevel</span> != <span class="string">'string'</span>) {
    <span class="variable">keys</span> = <span class="variable">topLevel</span>;
    <span class="variable">topLevel</span> = <span class="keyword">null</span>;
  } <span class="keyword">else</span> {
    <span class="variable">xml</span> += <span class="string">'&lt;'</span> + <span class="variable">xmlutils</span>.<span class="variable">decamelize</span>(<span class="variable">topLevel</span>) + <span class="string">'&gt;\n'</span>;
  }

  <span class="variable">keys</span> = <span class="variable">keys</span> || <span class="class">Object</span>.<span class="variable">keys</span>(<span class="variable">o</span>);

  <span class="variable">keys</span>.<span class="variable">forEach</span>(<span class="keyword">function</span>(<span class="variable">key</span>) {
    <span class="keyword">var</span> <span class="variable">tagName</span> = <span class="variable">xmlutils</span>.<span class="variable">decamelize</span>(<span class="variable">key</span>);
    <span class="variable">xml</span> += <span class="string">'&lt;'</span> + <span class="variable">tagName</span> + <span class="string">'&gt;'</span> + <span class="variable">o</span>[<span class="variable">key</span>].<span class="variable">toString</span>() + <span class="string">'&lt;/'</span> + <span class="variable">tagName</span> + <span class="string">'&gt;\n'</span>;
  });

  <span class="keyword">if</span> (<span class="variable">topLevel</span>) {
    <span class="variable">xml</span> += <span class="string">'&lt;/'</span> + <span class="variable">xmlutils</span>.<span class="variable">decamelize</span>(<span class="variable">topLevel</span>) + <span class="string">'&gt;\n'</span>;
  }
  
  <span class="keyword">return</span> <span class="variable">xml</span>;
};
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/authpost.js"><a href="#">authpost</a></h2></td><td>lib/authpost.js</td></tr><tr class="code">
<td class="docs">
<h1>authpost</h1>

<p>Copyright (c)2011, by Branko Vukelic</p>

<p>This library contains low-level methods for communicating with the Samurai
payment gateway. You should never need to access these methods directly.</p>

<p>The <code>makeRequest</code> method is used to send requests to the gateway using the 
credentials that have been set using the <code>config.configure()</code> and 
<code>config.option()</code> methods.</p>

<ul><li><strong>author</strong>: <em>Branko</em>
Vukelic <a href="mailto:branko@herdhound.com">branko@herdhound.com</a></li><li><strong>license</strong>: <em>MIT</em>
(see LICENSE)</li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">http</span> = <span class="variable">require</span>(<span class="string">'http'</span>);
<span class="keyword">var</span> <span class="variable">settings</span> = <span class="variable">require</span>(<span class="string">'./config'</span>).<span class="variable">settings</span>;
<span class="keyword">var</span> <span class="variable">debug</span> = <span class="variable">require</span>(<span class="string">'./config'</span>).<span class="variable">debug</span>;
<span class="keyword">var</span> <span class="variable">xmlutils</span> = <span class="variable">require</span>(<span class="string">'./xmlutils'</span>);
<span class="keyword">var</span> <span class="class">DaimyoError</span> = <span class="variable">require</span>(<span class="string">'./error'</span>);
<span class="keyword">var</span> <span class="class">API_VER</span> = <span class="variable">settings</span>.<span class="variable">apiVersion</span>;
<span class="keyword">var</span> <span class="class">API_HOST</span> = <span class="string">'samurai.feefighters.com'</span>;
<span class="keyword">var</span> <span class="class">API_URL</span> = <span class="string">'/v'</span> + <span class="class">API_VER</span>;
<span class="keyword">var</span> <span class="class">DEFAULT_PATH</span> = <span class="string">'/payment_methods'</span>;
<span class="keyword">var</span> <span class="class">DAIMYO_VERSION</span> = <span class="variable">require</span>(<span class="string">'./config'</span>).<span class="class">DAIMYO_VERSION</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>authpost.makeRequest([opts], callback)</h2>

<p><em>Low-level abstraction of http client functionality</em></p>

<p>All options are optional (no pun intended):</p>

<ul><li><em>path</em>: Path under the main gateway URL</li><li><em>method</em>: Either 'POST' or 'GET'</li><li><em>payload</em>: XML or urlencoded payload to send</li><li><em>headers</em>: Custom headers</li></ul>

<p>An example usage:</p>

<pre><code>authpost.makeRequest({
  path: '/payment_methods/xxxxxxxxxxxxxxxxxxxxxxxx.xml',
  method: 'PUT',
  payload: xmlData
}, function(err, res) {
  if (err) {
    // There was an error with the gateway
    console.log(err);
    return;
  }
  if (res.status !== 200) {
    // Bad status code
  }
  // etc...
});</code></pre>

<p>If the options are not provided, the request path will default to 
<code>/payment_methods</code>, and the request method will default to 'GET'. There is
no data that you can get from the default request, though, but it can be 
used to test the connection in general.</p>

<p>This method automatically sets the appropritate <code>Content-Length</code> and 
<code>Content-Type</code> headers. <code>Content-Type</code> can be either <code>text/xml</code> or 
<code>application/x-www-form-urlencoded</code>. The <code>Content-Type</code> is set based on the 
first character of the payload: if it is an lesser-than (<code>&lt;</code>) character, it
is set to <code>text/xml</code>.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  [opts] Request options</p></li><li><p><strong>param</strong>: <em>Function</em>  callback Callback that will be called with err and res</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">makeRequest</span> = <span class="keyword">function</span>(<span class="variable">opts</span>, <span class="variable">callback</span>) {
  <span class="keyword">var</span> <span class="variable">https</span> = <span class="variable">require</span>(<span class="string">'https'</span>);
  <span class="keyword">var</span> <span class="variable">path</span>;
  <span class="keyword">var</span> <span class="variable">method</span>;
  <span class="keyword">var</span> <span class="variable">payload</span>;
  <span class="keyword">var</span> <span class="variable">headers</span>;
  <span class="keyword">var</span> <span class="variable">requestOptions</span>;
  <span class="keyword">var</span> <span class="variable">request</span>;

  <span class="keyword">if</span> (!<span class="variable">settings</span>.<span class="variable">merchantKey</span> || !<span class="variable">settings</span>.<span class="variable">apiPassword</span>) {
    <span class="variable">callback</span>(<span class="keyword">new</span> <span class="class">DaimyoError</span>(<span class="string">'system'</span>, <span class="string">'Daimyo is not configured'</span>, <span class="variable">settings</span>));
  }

  <span class="keyword">if</span> (!<span class="variable">callback</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="keyword">typeof</span> <span class="variable">opts</span> === <span class="string">'function'</span>) {
    <span class="variable">callback</span> = <span class="variable">opts</span>;
    <span class="variable">opts</span> = {};
  }

  <span class="comment">// Is callback found?</span>
  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable">callback</span> !== <span class="string">'function'</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'Callback function is required'</span>);
  }

  <span class="variable">path</span> = <span class="class">API_URL</span> + (<span class="variable">opts</span>.<span class="variable">path</span> || <span class="class">DEFAULT_PATH</span>);
  <span class="variable">method</span> = <span class="variable">opts</span>.<span class="variable">method</span> || <span class="string">'GET'</span>; <span class="comment">// defaults to GET</span>
  <span class="variable">payload</span> = <span class="variable">opts</span>.<span class="variable">payload</span>;

  <span class="variable">debug</span>(<span class="variable">method</span> + <span class="string">' '</span> + <span class="variable">path</span> + <span class="string">' '</span> + (<span class="variable">payload</span> ? <span class="string">'with'</span> : <span class="string">'without'</span>) + <span class="string">' payload'</span>);
  <span class="variable">debug</span>(<span class="variable">payload</span>);

  <span class="comment">// Set headers</span>
  <span class="variable">headers</span> = {
    <span class="string">'Authorization'</span>: <span class="variable">generateCreds</span>(),
    <span class="string">'User-Agent'</span>: <span class="string">'Daimyo/'</span> + <span class="class">DAIMYO_VERSION</span> + <span class="string">' Node.js/'</span> + <span class="variable">process</span>.<span class="variable">version</span>,
    <span class="string">'Accepts'</span>: <span class="string">'text/plain; q=0.5, text/xml; q=0.8, text/html'</span>,
    <span class="string">'Date'</span>: <span class="keyword">new</span> <span class="class">Date</span>().<span class="variable">toString</span>()
  };

  <span class="keyword">if</span> (<span class="variable">payload</span>) {
    <span class="variable">headers</span>[<span class="string">'Content-Length'</span>] = <span class="variable">payload</span>.<span class="variable">length</span>;

    <span class="keyword">if</span> (<span class="variable">payload</span>[<span class="number integer">0</span>] === <span class="string">'&lt;'</span>) {
      <span class="variable">headers</span>[<span class="string">'Content-Type'</span>] = <span class="string">'text/xml'</span>;
    } <span class="keyword">else</span> {
      <span class="variable">headers</span>[<span class="string">'Content-Type'</span>] = <span class="string">'application/x-www-form-urlencoded'</span>;
    }
  }

  <span class="comment">// Set request options</span>
  <span class="variable">requestOptions</span> = {
    <span class="variable">host</span>: <span class="class">API_HOST</span>,
    <span class="variable">path</span>: <span class="variable">path</span>,
    <span class="variable">method</span>: <span class="variable">method</span>,
    <span class="variable">headers</span>: <span class="variable">headers</span>
  };

  <span class="comment">// Initialize the request object</span>
  <span class="variable">request</span> = <span class="variable">https</span>.<span class="variable">request</span>(<span class="variable">requestOptions</span>, <span class="keyword">function</span>(<span class="variable">response</span>) {
    <span class="keyword">var</span> <span class="variable">res</span> = {};
  
    <span class="variable">res</span>.<span class="variable">base</span> = <span class="variable">response</span>;
    <span class="variable">res</span>.<span class="variable">status</span> = <span class="variable">response</span>.<span class="variable">statusCode</span>;
    <span class="variable">res</span>.<span class="variable">headers</span> = <span class="variable">response</span>.<span class="variable">headers</span>;
    <span class="variable">res</span>.<span class="variable">body</span> = <span class="string">''</span>;

    <span class="comment">// response.setEncoding('UTF-8');</span>

    <span class="comment">// Buffer the response body</span>
    <span class="variable">response</span>.<span class="variable">on</span>(<span class="string">'data'</span>, <span class="keyword">function</span>(<span class="variable">chunk</span>) {
      <span class="variable">res</span>.<span class="variable">body</span> += <span class="variable">chunk</span>;
    });

    <span class="variable">response</span>.<span class="variable">on</span>(<span class="string">'end'</span>, <span class="keyword">function</span>(<span class="variable">err</span>) {
      <span class="keyword">var</span> <span class="variable">error</span>;

      <span class="comment">// System error</span>
      <span class="keyword">if</span> (<span class="variable">err</span>) {
        <span class="variable">error</span> = <span class="keyword">new</span> <span class="class">DaimyoError</span>(<span class="string">'system'</span>, <span class="string">'There was an error with the request'</span>, <span class="variable">err</span>);
      } <span class="keyword">else</span> {
        <span class="variable">error</span> = <span class="variable">parseMessages</span>(<span class="variable">res</span>.<span class="variable">body</span>);
      }
      
      <span class="variable">debug</span>(<span class="string">'Finished request with body: '</span> + <span class="variable">res</span>.<span class="variable">body</span>);
      <span class="variable">callback</span>(<span class="variable">error</span>, <span class="variable">res</span>);
    });
  });

  <span class="variable">request</span>.<span class="variable">on</span>(<span class="string">'error'</span>, <span class="keyword">function</span>(<span class="variable">err</span>) {
    <span class="variable">callback</span>(<span class="keyword">new</span> <span class="class">DaimyoError</span>(<span class="string">'system'</span>, <span class="string">'There was an error with the request'</span>, <span class="variable">err</span>));
  });

  <span class="keyword">if</span> (<span class="variable">payload</span>) { <span class="variable">request</span>.<span class="variable">write</span>(<span class="variable">payload</span>); }
  <span class="variable">request</span>.<span class="variable">end</span>();
};

</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/messages.js"><a href="#">messages</a></h2></td><td>lib/messages.js</td></tr><tr class="code">
<td class="docs">
<h1>messages</h1>

<p>Copyright (c)2011, by Branko Vukelic <a href="mailto:branko@herdhound.com">branko@herdhound.com</a></p>

<p>Translation of various gateway error messages to human-readable format.</p>

<p>All error messages generated by Samurai gateway are translated using the
<code>messages.translateAll</code> and <code>messages.translate</code> methods. The former 
translates all messages returned by <code>authpost.makeRequest</code> method, and the
latter translates individual messages.</p>

<p>In either case, what we end up with is a mapping between fields and 
messages. Depending on what you are trying to do, the fields can be card
data fields, transaction details fields, or virtual fields such as 
'gateway', or 'bank'.</p>

<ul><li><strong>author</strong>: <em>Branko</em>
Vukelic <a href="mailto:branko@herdhound.com">branko@herdhound.com</a></li><li><strong>license</strong>: <em>MIT</em>
(see LICENSE)</li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">msg</span> = <span class="variable">exports</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h1>messages.translate(message, lang)</h1>

<p><em>Returns a human readable string in given language</em></p>

<p>The return value is an object that maps a Daimyo field name to 
human-readable translation. The field name can be a virtual field like 
'system' or 'gateway', which indicates the error pretains to components of 
payment processing workflow, rather than a field.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  message Message object to be translated</p></li><li><p><strong>param</strong>: <em>String</em>  [lang] Optional language code (defaults to <code>en_US</code>)</p></li><li><p><strong>returns</strong>: <em>Object</em>  Object containing the field name, and human readable string</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">msg</span>.<span class="variable">translate</span> = <span class="keyword">function</span>(<span class="variable">message</span>, <span class="variable">lang</span>) {
  <span class="keyword">var</span> <span class="variable">mapping</span> = <span class="variable">msg</span>.<span class="variable">mappings</span>[<span class="variable">message</span>.<span class="variable">cls</span>][<span class="variable">message</span>.<span class="variable">context</span>][<span class="variable">message</span>.<span class="variable">key</span>];
  <span class="variable">lang</span> = <span class="variable">lang</span> || <span class="string">'en_US'</span>;
  <span class="keyword">return</span> {
    <span class="variable">field</span>: <span class="variable">mapping</span>[<span class="number integer">0</span>],
    <span class="variable">message</span>: <span class="variable">mapping</span>[<span class="number integer">1</span>](<span class="variable">lang</span>)
  };
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h1>messages.translateAll(messages, lang)</h1>

<p><em>Translate multiple messages, and return a single field-message mapping</em></p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Array</em>  messages Array of message objects</p></li><li><p><strong>param</strong>: <em>String</em>  [lang] Optional language code (defaults to <code>en_US</code>);</p></li><li><p><strong>returns</strong>: <em>Object</em>  Object containing the field names, and human readable strings</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">msg</span>.<span class="variable">translateAll</span> = <span class="keyword">function</span>(<span class="variable">messages</span>, <span class="variable">lang</span>) {
  <span class="keyword">var</span> <span class="variable">errors</span> = <span class="variable">messages</span>.<span class="variable">filter</span>(<span class="keyword">function</span>(<span class="variable">item</span>) {
    <span class="keyword">return</span> <span class="variable">item</span>.<span class="variable">cls</span> === <span class="string">'error'</span>;
  });
  <span class="keyword">var</span> <span class="variable">info</span> = <span class="variable">messages</span>.<span class="variable">filter</span>(<span class="keyword">function</span>(<span class="variable">item</span>) {
    <span class="keyword">return</span> <span class="variable">item</span>.<span class="variable">cls</span> === <span class="string">'info'</span>;
  });
  <span class="keyword">function</span> <span class="variable">build</span>(<span class="variable">msgs</span>) {
    <span class="keyword">var</span> <span class="variable">translations</span> = {};
    <span class="variable">msgs</span>.<span class="variable">forEach</span>(<span class="keyword">function</span>(<span class="variable">message</span>) {
      <span class="variable">translation</span> = <span class="variable">msg</span>.<span class="variable">translate</span>(<span class="variable">message</span>, <span class="variable">lang</span>);
      <span class="keyword">if</span> (<span class="variable">translations</span>.<span class="variable">hasOwnProperty</span>(<span class="variable">translation</span>.<span class="variable">field</span>) &<span class="variable">amp</span>;&<span class="variable">amp</span>; 
          <span class="variable">translations</span>[<span class="variable">translation</span>.<span class="variable">field</span>].<span class="variable">indexOf</span>(<span class="variable">translation</span>.<span class="variable">message</span>) &<span class="variable">lt</span>; <span class="number integer">0</span>) {
        <span class="variable">translations</span>[<span class="variable">translation</span>.<span class="variable">field</span>].<span class="variable">push</span>(<span class="variable">translation</span>.<span class="variable">message</span>);
      } <span class="keyword">else</span> {
        <span class="variable">translations</span>[<span class="variable">translation</span>.<span class="variable">field</span>] = [<span class="variable">translation</span>.<span class="variable">message</span>];
      }
    });
    <span class="keyword">return</span> <span class="variable">translations</span>;
  }
  <span class="keyword">return</span> {
    <span class="variable">errors</span>: <span class="variable">build</span>(<span class="variable">errors</span>),
    <span class="variable">info</span>: <span class="variable">build</span>(<span class="variable">info</span>)
  };
};
</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/error.js"><a href="#">error</a></h2></td><td>lib/error.js</td></tr><tr class="code">
<td class="docs">
<h1>error</h1>

<p>Copyright (c)2011, by Branko Vukelic <a href="mailto:branko@herdhound.com">branko@herdhound.com</a></p>

<p>DaimyoError object used as the main error object throughout the Daimyo 
implementation.</p>

<ul><li><strong>author</strong>: <em>Branko</em>
Vukelic <a href="mailto:branko@herdhound.com">branko@herdhound.com</a></li><li><strong>license</strong>: <em>MIT</em>
(see LICENSE)</li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">util</span> = <span class="variable">require</span>(<span class="string">'util'</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>error.DaimyoError</h2>

<p><em>Daimyo error object</em></p>

<ul><li><p><strong>constructo</strong>: <em>r</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">DaimyoError</span>(<span class="variable">category</span>, <span class="variable">message</span>, <span class="variable">details</span>) {
  <span class="this">this</span>.<span class="variable">category</span> = <span class="variable">category</span>;
  <span class="this">this</span>.<span class="variable">message</span> = <span class="variable">message</span>;
  <span class="this">this</span>.<span class="variable">details</span> = <span class="variable">details</span>;
}

<span class="variable">util</span>.<span class="variable">inherits</span>(<span class="class">DaimyoError</span>, <span class="class">Error</span>);

<span class="class">DaimyoError</span>.<span class="variable">prototype</span>.<span class="variable">toString</span> = <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="string">'DAIMYO_ERR in '</span> + <span class="this">this</span>.<span class="variable">category</span> + <span class="string">': '</span> + <span class="this">this</span>.<span class="variable">message</span> + <span class="string">'\n'</span> + 
    <span class="variable">util</span>.<span class="variable">inspect</span>(<span class="variable">details</span>);
};

<span class="variable">module</span>.<span class="variable">exports</span> = <span class="class">DaimyoError</span>;
</code></pre>
</td>
</tr>	</body>
</html></tbody></table>